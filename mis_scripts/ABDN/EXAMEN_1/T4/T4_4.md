Aqu√≠ tienes una gu√≠a detallada paso a paso para resolver la **Pr√°ctica 4.4: RDS Proxy con Multi-AZ**, basada en el documento proporcionado.

# Gu√≠a Paso a Paso: Pr√°ctica 4.4 - RDS Proxy con Multi-AZ

Esta pr√°ctica tiene como objetivo demostrar c√≥mo **RDS Proxy** ayuda a gestionar mejor las conexiones y, sobre todo, a reducir el tiempo de inactividad (downtime) durante un fallo (Failover) en una base de datos Multi-AZ.

---

### ‚úÖ Paso 1: Creaci√≥n de la Instancia RDS Multi-AZ

Primero necesitamos la base de datos principal con alta disponibilidad.

1. Ve a la consola de **RDS** y haz clic en **"Crear base de datos"**.
2. **Configuraci√≥n:**
* **Motor:** MySQL.
* **Plantilla:** Desarrollo y pruebas (Dev/Test).
* **Identificador:** `rds-proxy-tunombre` (ej. `rds-proxy-juan`).
* **Disponibilidad y durabilidad:** Selecciona **"Cl√∫ster de base de datos Multi-AZ"** o **"Instancia Multi-AZ"** (seg√∫n te permita tu cuenta, el PDF pide "Multi-AZ con una instancia en espera").
* **Credenciales:** Usuario `admin`. **Importante:** Anota la contrase√±a o elige la gesti√≥n por **Secrets Manager** si la opci√≥n te obliga, pero para el script necesitar√°s saber la contrase√±a en texto plano luego.
* **Conectividad:**
* **VPC:** Elige la VPC por defecto (o la que uses para pr√°cticas).
* **Grupo de seguridad:** Selecciona **"Crear nuevo"** y ll√°malo `gs-rds`.


* **Autenticaci√≥n de base de datos:** El PDF menciona "Secrets Manager". Aseg√∫rate de que la instancia guarde las credenciales en AWS Secrets Manager (esto suele generar un secreto autom√°ticamente).


3. Crea la base de datos y espera a que est√© en estado "Disponible".
4. **Base de datos l√≥gica:** Con√©ctate a la instancia (usando un cliente como DBeaver o desde CloudShell) y crea la base de datos de prueba que usar√° el script:
```sql
CREATE DATABASE pru;

```



---

### ‚úÖ Paso 2: Creaci√≥n del RDS Proxy

El Proxy actuar√° de intermediario entre tu aplicaci√≥n (Cloud9) y la base de datos.

1. En la consola RDS, selecciona tu base de datos `rds-proxy-tunombre`.
2. Ve al bot√≥n **Acciones** > **Crear proxy de RDS**.
3. **Configuraci√≥n del Proxy:**
* **Identificador:** `proxy-tunombre`.
* **Compatibilidad de motor:** MySQL.
* **Base de datos de destino:** Selecciona tu instancia `rds-proxy-tunombre`.
* **Autenticaci√≥n:**
* Elige el secreto de **Secrets Manager** que se cre√≥ en el Paso 1.
* **Rol de IAM:** Elige `LabRole` (o crea uno nuevo si AWS te lo pide y tienes permisos) que permita al proxy leer el secreto.
* **Configuraci√≥n de autenticaci√≥n:** Aseg√∫rate de que "Requerir Transport Layer Security (TLS)" no te d√© problemas si tu script no usa SSL, aunque lo ideal es dejarlo. Para esta pr√°ctica, si el script falla, puedes revisar esto.


* **Conectividad:**
* **Grupo de seguridad:** Selecciona **"Crear nuevo"** y ll√°malo `gs-proxy`.




4. Haz clic en **Crear proxy**. Tardar√° unos minutos.

---

### üîí Paso 3: Configuraci√≥n de Seguridad (Grupos de Seguridad)

Este paso es cr√≠tico para que todo funcione. Tienes 3 elementos: **Cloud9** (cliente), **Proxy** (intermediario) y **RDS** (destino).

1. Ve a la consola **EC2** > **Grupos de seguridad**.
2. **Configurar `gs-proxy` (El del Proxy):**
* Reglas de entrada: Permitir tr√°fico TCP puerto **3306**.
* **Origen:** El Grupo de Seguridad de tu entorno **Cloud9** (o la IP de la subred si no lo encuentras, p.ej. `172.31.0.0/16` para probar, aunque lo correcto es el SG del cliente).


3. **Configurar `gs-rds` (El de la Base de Datos):**
* Borra cualquier regla existente.
* Reglas de entrada: Permitir tr√°fico TCP puerto **3306**.
* **Origen:** **IMPORTANTE**, selecciona el grupo de seguridad **`gs-proxy`**.
* *Explicaci√≥n:* Esto obliga a que nadie entre directo a la BD salvo que pase por el Proxy (aunque para la primera prueba del script `rds.py` necesitar√°s abrir temporalmente tu IP o el SG de Cloud9 tambi√©n al `gs-rds`).
* **Nota para la pr√°ctica:** Como tienes que probar conexi√≥n directa con `rds.py`, a√±ade tambi√©n en `gs-rds` una regla que permita el tr√°fico desde el SG de Cloud9.



---

### üíª Paso 4: Preparaci√≥n del Entorno Cloud9

1. Crea (o usa) un entorno **Cloud9** en la **misma VPC** que tus bases de datos.
2. Abre la terminal de Cloud9 e instala la librer√≠a de MySQL para Python:
```bash
pip3 install pymysql

```


3. **Crear el script `rds.py` (Conexi√≥n Directa):**
* Crea un nuevo archivo llamado `rds.py`.
* Copia el c√≥digo del anexo (ver abajo) y modifica:
* `host`: Pega el **Punto de enlace (Endpoint)** de la instancia RDS.
* `user`: `admin`.
* `password`: La contrase√±a que definiste.
* `database`: `pru`.




4. **Crear el script `proxy.py` (Conexi√≥n v√≠a Proxy):**
* Crea un archivo llamado `proxy.py`.
* Copia el mismo c√≥digo pero modifica:
* `host`: Pega el **Punto de enlace del Proxy** (lo encuentras en la secci√≥n "Proxies" de la consola RDS).





**C√≥digo Python (basado en el anexo del PDF):**

```python
import pymysql
import time

# Configura aqu√≠ tus datos
DB_HOST = "PUNTO_DE_ENLACE_AQUI" # Cambiar por RDS o Proxy seg√∫n el fichero
DB_USER = "admin"
DB_PASS = "tu_contrase√±a_aqui"
DB_NAME = "pru"

def run_test(host):
    # Aumentamos el rango a 100 para que de tiempo a ver el failover
    for i in range(100): 
        try:
            conn = pymysql.connect(
                host=host,
                user=DB_USER,
                password=DB_PASS,
                database=DB_NAME,
                connect_timeout=3
            )
            with conn.cursor() as cur:
                cur.execute("SELECT 1;")
            print(f"[{i}] OK")
            conn.close()
        except Exception as e:
            print(f"[{i}] ERROR: {e}")
        time.sleep(1)

run_test(DB_HOST)

```

---

### üß™ Paso 5 y 6: Ejecuci√≥n y Simulaci√≥n de Fallo

Aqu√≠ es donde verificar√°s la ventaja del Proxy.

#### Prueba A: Conexi√≥n Directa (Sin Proxy)

1. En Cloud9, ejecuta: `python3 rds.py`
2. Mientras salen los mensajes "OK", ve a la consola RDS.
3. Selecciona tu instancia > **Acciones** > **Reiniciar**.
4. Marca la casilla **"Reiniciar con conmutaci√≥n por error" (Failover)** y confirma.
5. **Observa la terminal:** Ver√°s muchos mensajes de `ERROR` de conexi√≥n mientras la BD cambia de zona. Cuenta (aproximadamente) cu√°ntos errores salen.

#### Prueba B: Conexi√≥n v√≠a Proxy

1. En Cloud9, ejecuta: `python3 proxy.py`
2. Repite el proceso de **Reiniciar con conmutaci√≥n por error** en la consola RDS.
3. **Observa la terminal:** Deber√≠as ver **menos errores** o una recuperaci√≥n mucho m√°s r√°pida. El Proxy mantiene las conexiones "vivas" o las encola mientras la BD hace el cambio por detr√°s.

#### M√©tricas (CloudWatch)

Ve a CloudWatch > M√©tricas > RDS. Busca las gr√°ficas de:

* `DatabaseConnections` (en la instancia RDS).
* `ClientConnections` (en el Proxy).
Compara c√≥mo caen las conexiones en la Prueba A vs Prueba B.

---

### üì∏ Capturas para Entregar (Evidencias)

Para verificar que has realizado la pr√°ctica correctamente, toma estas capturas:

1. **Configuraci√≥n RDS:** Pantalla de detalles de la BD donde se vea que es **Multi-AZ**.
2. **Configuraci√≥n Proxy:** Pantalla de detalles del Proxy donde se vea el estado "Disponible" y el destino apuntando a tu RDS.
3. **C√≥digo:** Captura de pantalla de Cloud9 con los ficheros `rds.py` y `proxy.py` abiertos.
4. **Failover Directo:** Captura de la terminal ejecutando `rds.py` donde se vea la **serie de errores** producidos durante el reinicio.
5. **Failover con Proxy:** Captura de la terminal ejecutando `proxy.py` durante el reinicio, demostrando que hubo **menos interrupciones** (menos l√≠neas de error).
6. **Gr√°ficas (Opcional pero recomendado):** Captura de CloudWatch comparando las conexiones.

**T√≠tulo sugerido para tu respuesta:** *Implementaci√≥n y An√°lisis de Failover con Amazon RDS Proxy en Entorno Multi-AZ.*
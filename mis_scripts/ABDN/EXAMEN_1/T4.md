춰Entendido! Llegamos al **Tema 4 (T4): Recuperaci칩n ante Desastres (Disaster Recovery - DR)**.

Si el T3 iba sobre "velocidad", el T4 va sobre **"supervivencia"**. Aqu칤 aprender치s a configurar la base de datos para que sobreviva a un terremoto digital, un borrado accidental o una ca칤da del centro de datos.

---

# 游닂 T4. Recuperaci칩n ante Desastres y Alta Disponibilidad

## Ejercicio 1: Multi-AZ (Alta Disponibilidad)

**Concepto Clave:** Multi-AZ (Multiple Availability Zones) no es para mejorar el rendimiento (eso son las r칠plicas de lectura). Es para **seguridad**.
AWS crea una base de datos "espejo" en otro edificio. T칰 no puedes entrar en ese espejo. Pero si tu edificio se incendia, AWS redirige los cables al edificio espejo autom치ticamente.

**Escenario:** Vamos a convertir tu instancia "Single-AZ" (vulnerable) en "Multi-AZ" (resistente).

### Pasos:
1.  **Selecciona tu RDS:** Ve a **Databases** y elige tu instancia (debe estar en estado *Available*).
2.  **Modificar:** Clic en **Modify**.
3.  **Configurar Multi-AZ:**
    *   Busca la secci칩n **Availability & durability**.
    *   Cambia la opci칩n de "Single DB instance" a **Create a standby instance** (Recommended for production).
    *   *Nota:* Ver치s que hay opci칩n de "Multi-AZ DB Cluster" (m치s moderno, con 2 legibles), pero para el examen cl치sico c칠ntrate en la **Instance**.
4.  **Aplicar:**
    *   Baja al final -> **Continue**.
    *   En el resumen, ver치s que el coste estimado se **duplica** (l칩gico, ahora tienes dos m치quinas).
    *   Selecciona **Apply immediately**.
    *   **Modify DB Instance**.

**Lo que suceder치 (Ojo para el examen):**
*   El estado pasar치 a **Modifying**.
*   AWS est치 creando una copia oculta en otra zona (ej. si estabas en `us-east-1a`, crea una en `us-east-1b`).
*   La replicaci칩n es **S칤ncrona** (El dato no se confirma hasta que se guarda en los dos sitios).
*   **No cambia tu Endpoint.** Tu aplicaci칩n sigue usando la misma URL.

---

## Ejercicio 2: Backups (Autom치ticos vs Manuales vs AWS Backup)

Aqu칤 vamos a ver c칩mo recuperar datos si alguien borra una tabla por error.

### A. Backups Autom치ticos y PITR (Point-in-Time Recovery)
*Ya vienen activados por defecto si no los quitaste.*

1.  Selecciona tu instancia.
2.  Pesta침a **Maintenance & backups**.
3.  Baja hasta ver **Automated backups**.
4.  **El Ejercicio Mental (Restauraci칩n):**
    *   Imagina que hoy a las 14:00 alguien borr칩 clientes.
    *   No puedes "deshacer" el cambio en la base de datos actual. Tienes que crear una nueva.
    *   Ve arriba, bot칩n **Actions** -> **Restore to point in time**.
    *   Selecciona **Latest restorable time** o **Custom**.
    *   Elige una hora (ej. Hoy a las 13:55).
    *   Ponle un nombre nuevo (ej. `rds-restaurada`).
    *   Al darle a crear, AWS usar치 los **Redo Logs** (ver punto 4) para reconstruir la historia segundo a segundo hasta ese momento exacto.

### B. AWS Backup (Gesti칩n Centralizada)
*Ideal para empresas que quieren gestionar backups de EC2, RDS y S3 en un solo sitio.*

1.  Busca el servicio **AWS Backup** en la consola.
2.  **Create backup plan** -> **Start with a template**.
3.  Elige "Daily-35day-Retention" (ejemplo).
4.  Dale un nombre `Plan-Examen`.
5.  **Assign resources:**
    *   Dale un nombre a la asignaci칩n (ej. `Recursos-Criticos`).
    *   **Resource type:** Selecciona **RDS**.
    *   **Database names:** Selecciona tu base de datos.
6.  Esto crear치 una pol칤tica que forzar치 backups externos independientemente de lo que configures en la RDS.

---

## Ejercicio 3: RDS Proxy

**Concepto Clave:** Si tu base de datos principal cae (Failover) y pasa a la Standby (Multi-AZ), hay un corte de unos 60-120 segundos donde el DNS cambia. Tu aplicaci칩n dar칤a error.
**RDS Proxy** se pone en medio. La aplicaci칩n conecta al Proxy. Si la BD cae, el Proxy espera y reconecta sin que la aplicaci칩n se entere (o reduciendo el error a segundos).

**Requisito Previo: Secrets Manager**
El Proxy necesita guardar usuario y contrase침a de forma segura para poder conectar por ti.

1.  Busca **Secrets Manager** en la consola.
2.  **Store a new secret**.
3.  **Secret type:** Credentials for Amazon RDS database.
4.  **Credentials:** User `admin`, Password `Admin12345`.
5.  **Database:** Selecciona tu instancia RDS de la lista.
6.  Next -> Name: `secreto-rds-proxy`.
7.  Next -> Next -> **Store**.

**Crear el Proxy:**
1.  Vuelve a la consola **RDS**.
2.  Men칰 izquierdo: **Proxies**.
3.  **Create proxy**.
4.  **Proxy identifier:** `mi-proxy-examen`.
5.  **Engine family:** MySQL.
6.  **Target group config:** Database -> Elige tu RDS.
7.  **Authentication:**
    *   **Secrets Manager secret:** Elige `secreto-rds-proxy` (el que acabas de crear).
    *   **IAM Role:** Deja "Create IAM role". (AWS crear치 el permiso para que el Proxy pueda leer el secreto).
8.  **Connectivity:**
    *   Subnets: Selecciona al menos dos.
    *   **VPC Security Group:** Selecciona el mismo que tu base de datos (`sg-rds-privada` o similar).
9.  **Create proxy**.

**Resultado:**
*   Tardar치 un rato (15 min).
*   Al terminar, te dar치 un **Proxy Endpoint**.
*   En tu aplicaci칩n (o en el Workbench), en lugar de poner el endpoint de la BD, pones el del Proxy.

---

## Ejercicio 4: Teor칤a de Redo Logs (Para responder en el examen)

En RDS no hay un bot칩n que diga "Configurar Redo Logs", es interno, pero **debes saber esto para el examen**:

1.  **쯈u칠 son?** Son ficheros secuenciales donde se anota todo lo que pasa. "Se insert칩 X", "Se borr칩 Y".
2.  **쯇ara qu칠 sirven?**
    *   **Durabilidad:** Si se va la luz justo despu칠s de un INSERT pero antes de que se guarde en el disco duro, al reiniciar, RDS lee el Redo Log y dice "춰Ah! Me falt칩 guardar esto" y lo recupera.
    *   **R칠plicas:** RDS env칤a los Redo Logs a las R칠plicas de Lectura para que se actualicen.
    *   **Point-in-Time Recovery:** AWS coge un Snapshot viejo y le "aplica" los Redo Logs uno tras otro hasta llegar a la hora que t칰 pediste.

---

## Resumen T4 para Examen

| Tecnolog칤a | 쯈u칠 protege? | Tiempo de recuperaci칩n (RTO) |
| :--- | :--- | :--- |
| **Backup (Snapshot)** | Borrado de datos / Corrupci칩n | Alto (Minutos/Horas en restaurar nueva BD) |
| **Multi-AZ** | Fallo de Hardware / Zona ca칤da | Bajo (60-120 segundos autom치tico) |
| **RDS Proxy** | Cortes de conexi칩n durante Failover | Muy bajo (Reduce el corte de Multi-AZ al mantener conexiones) |
| **Read Replica** | Rendimiento (No es DR estrictamente) | Sirve para DR manual (promocionar r칠plica a master) |

---

### 丘멆잺 Limpieza Urgente T4 (Evitar Cobros)
Este tema crea recursos caros. Limpia en este orden:
1.  **RDS Proxy:** B칩rralo (cobra por hora).
2.  **Secret:** Ve a Secrets Manager y borra el secreto (progr치malo para borrado inmediato si te deja, o 7 d칤as).
3.  **Multi-AZ:** Modifica tu RDS y vuelve a ponerla en **Single-DB Instance** (si no la vas a borrar del todo).
4.  **Instancia RDS:** Si ya terminaste por hoy, borra la base de datos (y recuerda desmarcar "Create final snapshot" si no quieres guardar nada).

쮼ntendido el T4? La combinaci칩n **Multi-AZ + Backups** es la respuesta est치ndar a "쮺칩mo aseguro mis datos?".
Si est치s listo, nos queda el **T5 (Mantenimiento)** para cerrar el temario.
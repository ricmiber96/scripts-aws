¬°Vamos a por el **Tema 3 (T3)**! Este es uno de los temas favoritos en los ex√°menes de certificaci√≥n de AWS.

Aqu√≠ aprender√°s a responder a la pregunta: **"Mi base de datos va lenta, ¬øqu√© hago?"**.

Existen dos formas de solucionar la lentitud:
1.  **Escalado Vertical:** Cambiar el motor del coche por uno m√°s grande (M√°s CPU/RAM).
2.  **Escalado Horizontal:** Comprar m√°s coches para llevar a m√°s gente (Crear copias de lectura).

---

# üìò T3. Escalado de Bases de Datos Relacionales

## Ejercicio 1: Escalado Vertical (Vertical Scaling)

**El Escenario:** Tienes una instancia `db.t3.micro` (la peque√±a de la capa gratuita) y la CPU est√° al 100% porque tienes muchos usuarios. Necesitas pasar a una `db.t3.small` (el doble de potencia) urgentemente.

**‚ö†Ô∏è Nota importante:** El escalado vertical implica **parada de servicio (downtime)**. Durante unos minutos, la base de datos se reiniciar√° para cambiar el hardware.

### Pasos Detallados:
1.  **Seleccionar la v√≠ctima:**
    *   Ve a la consola **RDS** -> **Databases**.
    *   Selecciona tu instancia (por ejemplo, `rds-examen-publica` o la que tengas activa).
    *   Comprueba que el estado sea **Available** (Verde).

2.  **Modificar la instancia:**
    *   Haz clic en el bot√≥n blanco superior derecho: **Modify** (Modificar).

3.  **Cambiar el tama√±o:**
    *   Busca la secci√≥n **Instance configuration**.
    *   Ver√°s que est√° seleccionada `db.t3.micro`.
    *   Despliega el men√∫ y selecciona el siguiente tama√±o: **db.t3.small** (o `medium`).
    *   *Nota:* Si no te deja elegir, aseg√∫rate de que arriba en "DB instance class" no est√©s filtrando solo por clases espec√≠ficas.

4.  **Aplicar el cambio (El truco del examen):**
    *   Baja hasta el final de la p√°gina y haz clic en **Continue**.
    *   Ahora ver√°s una pantalla de "Summary of modifications" (Resumen).
    *   Ver√°s un apartado que dice **Scheduling of modifications** (Programaci√≥n).
    *   üî¥ **Selecciona: Apply immediately** (Aplicar inmediatamente).
    *   *¬øPor qu√©?* Si seleccionas "During the next scheduled maintenance window", AWS esperar√° al domingo de madrugada (o cuando sea tu ventana) para hacerlo. T√∫ lo quieres **YA**.

5.  **Ejecutar:**
    *   Haz clic en **Modify DB Instance**.

6.  **Observar:**
    *   Vuelve a la lista de bases de datos.
    *   El estado cambiar√° a **Modifying** (azul).
    *   La base de datos se apagar√° y se encender√° en el nuevo hardware. Tarda unos 5-10 minutos.

---

## Ejercicio 2: Escalado Horizontal - RDS Standard (Read Replicas)

**El Escenario:** Tu tienda online va lenta, pero no por falta de CPU para escribir pedidos, sino porque hay **miles de personas mirando el cat√°logo (haciendo SELECTs)**.
**Soluci√≥n:** Creas una copia exacta (R√©plica) para que la gente lea de ah√≠, liberando a la base de datos principal (Master).

### Requisito Previo (Obligatorio)
Para crear r√©plicas, los **Backups Autom√°ticos** deben estar activados en la instancia original.
*   Si al intentar el paso siguiente te da error, ve a *Modify -> Additional configuration -> Backup -> Retention period: 1 day (o m√°s)* y aplica cambios.

### Pasos Detallados:
1.  **Crear la R√©plica:**
    *   Selecciona tu instancia **Original** (la que est√° Available).
    *   Haz clic en el bot√≥n **Actions**.
    *   Selecciona **Create read replica** (Crear r√©plica de lectura).

2.  **Configurar la R√©plica:**
    *   **DB instance identifier:** Ll√°mala `rds-replica-lectura`.
    *   **Destination Region:** Puedes crearla en otra parte del mundo (para usuarios de Asia, por ejemplo), pero para este ejercicio, d√©jala en la **misma regi√≥n** (ej. us-east-1).
    *   **Instance configuration:** Puedes elegir un tama√±o igual, mayor o menor que la original. D√©jalo igual (`micro` o `small`).
    *   *Nota:* F√≠jate que no te pide usuario ni contrase√±a. Hereda los de la principal.

3.  **Lanzar:**
    *   Clic en **Create read replica**.

4.  **Entender el Resultado (Clave para el examen):**
    *   Espera a que termine (tarda un rato).
    *   Ahora tendr√°s **DOS Endpoints (URLs)** diferentes:
        1.  **Endpoint A (Original):** Para `INSERT`, `UPDATE`, `DELETE` y `SELECT`.
        2.  **Endpoint B (R√©plica):** SOLO para `SELECT`.
    *   *Tu trabajo como arquitecto:* Tienes que ir al c√≥digo de tu aplicaci√≥n y decirle: "Cuando quieras leer datos, usa la URL de la R√©plica".

---

## Ejercicio 3: Escalado Horizontal - RDS Aurora

**El Escenario:** Igual que el anterior, pero usando **Amazon Aurora**.
**Diferencia:** En Aurora, el escalado es mucho m√°s elegante. Todos los datos est√°n compartidos en un almacenamiento virtual, por lo que a√±adir una r√©plica es rapid√≠simo y no duplica el almacenamiento.

### Pasos Detallados:
*Nota: Necesitas un cl√∫ster de Aurora activo (como vimos en el T2). Si no lo tienes, cr√©alo r√°pido (Aurora MySQL -> Dev/Test).*

1.  **A√±adir un Lector (Reader):**
    *   Selecciona el **Cl√∫ster** de Aurora (la fila que agrupa las instancias).
    *   Haz clic en **Actions** -> **Add reader** (A√±adir lector).

2.  **Configurar:**
    *   **DB instance identifier:** `aurora-lector-1`.
    *   Haz clic en **Add reader**.

3.  **La Magia de los Endpoints de Aurora (Diferencia con RDS Standard):**
    *   Cuando termine, selecciona el Cl√∫ster y mira la pesta√±a **Connectivity & security**.
    *   Ver√°s dos Endpoints especiales que **nunca cambian**, no importa cu√°ntas r√©plicas a√±adas o quites:
        1.  **Writer Endpoint (Escritura):** Siempre apunta a la instancia principal.
        2.  **Reader Endpoint (Lectura):** Este es un **Balanceador de Carga**.
    *   *Explicaci√≥n:* Si creas 5 r√©plicas (lectores), Aurora te da una sola URL (Reader Endpoint). T√∫ pones esa URL en tu aplicaci√≥n. Aurora se encarga de repartir las visitas entre las 5 r√©plicas autom√°ticamente.
    *   En RDS Standard (Ejercicio 2) t√∫ ten√≠as que gestionar manualmente a qu√© r√©plica te conectabas. En Aurora es autom√°tico.

---

## Resumen para el T3 (Preguntas de examen)

| Concepto | RDS Standard | Aurora |
| :--- | :--- | :--- |
| **Escalado Vertical** | Instance type (t3.micro -> t3.small). Requiere reinicio. | Igual. (O usar Serverless v2 para que sea auto). |
| **Escalado Horizontal** | Creas "Read Replicas". Cada una tiene su propia IP (Endpoint). | Creas "Readers". Hay un √∫nico "Reader Endpoint" que balancea el tr√°fico. |
| **L√≠mite de R√©plicas** | M√°ximo 5 (generalmente, ha subido en versiones recientes pero qu√©date con que son pocas). | M√°ximo 15 r√©plicas. |
| **Lag (Retraso)** | Puede haber segundos de retraso en la r√©plica. | Milisegundos (muy bajo), comparten disco. |

---

### Limpieza del T3
*   Borra la `rds-replica-lectura` (primero la r√©plica, luego la original si quieres).
*   Borra el lector de Aurora y el cl√∫ster.

¬øTodo claro con el escalado? Si te fijas, la clave es: **Vertical = Potencia (CPU)** y **Horizontal = Cantidad (Lectura)**.

¬øListo para pasar al **T4 (Recuperaci√≥n ante desastres)**? Aqu√≠ es donde la cosa se pone seria para asegurar los datos.


¬°Excelente idea! Este es uno de los ejercicios m√°s visuales y gratificantes porque ver√°s c√≥mo tus acciones de c√≥digo impactan directamente en la infraestructura en tiempo real.

Vamos a simular un escenario donde tu aplicaci√≥n se vuelve viral y recibe miles de peticiones por segundo.

---

# üìò Ejercicio Extra T3: Test de Estr√©s con Cloud9 y CloudWatch

**Objetivo:** Crear un entorno de desarrollo (Cloud9), escribir un script en Python que "ataque" la base de datos con miles de inserciones y visualizar c√≥mo la CPU de la RDS se dispara en CloudWatch.

---

## Paso 1: Preparar la V√≠ctima (Tu RDS)

Si ya tienes una RDS creada de los ejercicios anteriores (MySQL, capa gratuita `db.t3.micro`), √∫sala. Si no, crea una r√°pida:

1.  **RDS** -> **Create database** -> **Standard Create**.
2.  **Engine:** MySQL.
3.  **Template:** Free Tier.
4.  **Identifier:** `rds-victima`.
5.  **Master user:** `admin` | **Password:** `Admin12345`.
6.  **Connectivity:** No Public Access (vamos a atacar desde dentro de AWS).
7.  **VPC Security Group:** Create new (`sg-rds-victima`).
8.  **Create database**.

---

## Paso 2: Crear el Atacante (AWS Cloud9)

Cloud9 es un IDE (editor de c√≥digo) que corre sobre una instancia EC2 en tu navegador. Es perfecto para ejecutar scripts sin configurar tu PC local.

1.  Busca **Cloud9** en la consola.
2.  Clic en **Create environment**.
3.  **Name:** `Entorno-Estres`.
4.  **Environment type:** New EC2 instance (Direct access).
5.  **Instance type:** `t2.micro` (Capa gratuita).
6.  **Platform:** Amazon Linux 2023.
7.  **Network settings:**
    *   **VPC:** La misma que tu RDS (importante).
    *   **Subnet:** Cualquiera disponible.
8.  Clic en **Create**.
9.  Tardar√° 1-2 minutos. Cuando est√© listo, dale a **Open** en "Cloud9 IDE".

---

## Paso 3: Conectar Atacante y V√≠ctima (Security Groups)

El Cloud9 est√° en una EC2 oculta. Necesitamos que la RDS le deje pasar.

1.  Ve a la consola de **EC2** (en otra pesta√±a).
2.  En el men√∫ izquierdo, **Instances**. Busca la instancia que se llama `aws-cloud9-Entorno-Estres...`.
3.  Selecci√≥nala y abajo, en la pesta√±a **Security**, mira el nombre de su Security Group (ej. `launch-wizard-1` o un nombre largo generado por Cloud9). **Copia el ID (sg-xxxxxxxx)**.
4.  Ve a la consola de **RDS**.
5.  Selecciona tu `rds-victima`.
6.  Clic en su **VPC security group** (el enlace activo).
7.  Pesta√±a **Inbound rules** -> **Edit inbound rules**.
8.  **Add rule**:
    *   **Type:** MySQL/Aurora (3306).
    *   **Source:** Pega el ID del Security Group del Cloud9 (el que copiaste en el punto 3).
9.  **Save rules**.

---

## Paso 4: El Script de Estr√©s (Python)

Vuelve a la pesta√±a de tu entorno **Cloud9**. Ver√°s una terminal abajo.

1.  **Instalar librer√≠a de MySQL:**
    En la terminal de Cloud9 (abajo), escribe:
    ```bash
    pip install pymysql
    ```

2.  **Crear el archivo del script:**
    *   Arriba a la izquierda, **File** -> **New File**.
    *   Pega el siguiente c√≥digo (aseg√∫rate de cambiar el HOST por tu endpoint):

    ```python
    import pymysql
    import time
    import threading

    # --- CONFIGURACI√ìN ---
    # Ve a la consola RDS y copia tu Endpoint
    DB_HOST = "pega-aqui-tu-endpoint.xxxxxx.us-east-1.rds.amazonaws.com" 
    DB_USER = "admin"
    DB_PASS = "Admin12345"
    DB_NAME = "testdb"

    # --- PREPARACI√ìN DE LA BD ---
    def setup_db():
        print("--- Conectando para crear base de datos ---")
        try:
            conn = pymysql.connect(host=DB_HOST, user=DB_USER, password=DB_PASS)
            cursor = conn.cursor()
            cursor.execute(f"CREATE DATABASE IF NOT EXISTS {DB_NAME}")
            cursor.execute(f"USE {DB_NAME}")
            cursor.execute("CREATE TABLE IF NOT EXISTS carga (id INT AUTO_INCREMENT PRIMARY KEY, datos VARCHAR(255))")
            conn.commit()
            conn.close()
            print("--- Base de datos y tabla listas ---")
        except Exception as e:
            print(f"Error en setup: {e}")

    # --- FUNCI√ìN DE ATAQUE ---
    def estresar():
        try:
            conn = pymysql.connect(host=DB_HOST, user=DB_USER, password=DB_PASS, database=DB_NAME)
            cursor = conn.cursor()
            while True:
                # Insertamos datos basura continuamente
                cursor.execute("INSERT INTO carga (datos) VALUES ('ESTRESANDO LA BASE DE DATOS CON CLOUD9')")
                conn.commit()
        except Exception as e:
            print(e)

    # --- EJECUCI√ìN MULTI-HILO ---
    if __name__ == "__main__":
        setup_db()
        print("!!! INICIANDO ATAQUE DE ESTR√âS !!! (Pulsa Ctrl+C para parar)")
        
        # Lanzamos 50 hilos simult√°neos para simular 50 usuarios a la vez
        for i in range(50):
            t = threading.Thread(target=estresar)
            t.daemon = True # Para que se cierren al cerrar el script
            t.start()
            
        # Mantenemos el script vivo
        while True:
            time.sleep(1)
    ```

3.  **Guardar:**
    *   Presiona `Ctrl + S`.
    *   Gu√°rdalo como `ataque.py`.

4.  **Ejecutar:**
    *   En la terminal escribe:
    ```bash
    python ataque.py
    ```
    *   Deber√≠as ver "!!! INICIANDO ATAQUE DE ESTR√âS !!!". Si da error, revisa el Endpoint y el Security Group.

---

## Paso 5: Visualizar en CloudWatch (La hora de la verdad)

Deja el script corriendo. Est√° insertando miles de l√≠neas por segundo desde 50 "usuarios" a la vez.

1.  Ve a la consola de **RDS**.
2.  Entra en tu instancia `rds-victima`.
3.  Haz clic en la pesta√±a **Monitoring**.
4.  Aqu√≠ ver√°s gr√°ficas peque√±as. Busca **CPU Utilization** y **DB Connections**.
    *   *Nota:* CloudWatch tiene un retraso de 1 a 2 minutos. **Ten paciencia.**
5.  Para verlo mejor:
    *   Arriba a la derecha de las gr√°ficas, hay un bot√≥n que dice **Monitoring dashboard** o haz clic en los tres puntos de la gr√°fica de CPU -> **View in metrics**.
    *   Esto te lleva a la consola completa de **CloudWatch**.

**Lo que deber√≠as ver:**
*   La l√≠nea de **DB Connections** subir√° de 0 a 50 de golpe.
*   La l√≠nea de **CPU Utilization** empezar√° a subir. Al ser una `t3.micro` (muy peque√±a), es probable que llegue al 20%, 40% o incluso m√°s alto r√°pidamente.

---

## Paso 6: Resoluci√≥n del Ejercicio (Escalado)

Imag√≠nate que esto es real y la CPU llega al 90%. El sistema va lento.

**¬øQu√© har√≠as? (Pr√°ctica mental T3)**
1.  **Opci√≥n A (Vertical):** Modificar la instancia y cambiarla a `db.t3.small` (m√°s CPU).
2.  **Opci√≥n B (Horizontal):** Si el problema fueran muchas lecturas (SELECT), crear√≠as una Read Replica y cambiar√≠as el script para que lea de la r√©plica.

---

## Paso 7: Limpieza (¬°Importante!)

1.  **Para el script:** En Cloud9, haz clic en la terminal y pulsa `Ctrl + C` para detener el ataque.
2.  **Borra el entorno Cloud9:** Ve a la consola Cloud9, selecciona `Entorno-Estres` y dale a **Delete**. (Esto borra la EC2 asociada autom√°ticamente).
3.  **Borra la RDS:** Si no la necesitas para el T4.

¬°Has logrado estresar una infraestructura en la nube y monitorizarla como un ingeniero DevOps! ¬øListo para el **T4 (Recuperaci√≥n ante desastres)**?